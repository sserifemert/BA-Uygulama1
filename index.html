<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sanal KÃ¼tÃ¼phane | EtÃ¼t OdasÄ±</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="library-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h3>ğŸ“œ ZiyaretÃ§i Defteri</h3>
          <div class="online-status">
            <span class="indicator"></span>
            <span id="userCount">0</span> Ã–ÄŸrenci Ã‡alÄ±ÅŸÄ±yor
          </div>
        </div>

        <div class="user-controls">
          <label>Takma AdÄ±nÄ±z</label>
          <div class="input-group">
            <input
              type="text"
              id="usernameInput"
              placeholder="Ä°sim giriniz..."
              autocomplete="off"
            />
            <button id="setUsernameBtn">Yenile</button>
          </div>
        </div>

        <div class="library-rules">
          <h4>KÃ¼tÃ¼phane KurallarÄ±</h4>
          <ul>
            <li>LÃ¼tfen sessiz olunuz.</li>
            <li>Sadece bilgi paylaÅŸÄ±mÄ± yapÄ±nÄ±z.</li>
            <li>KitaplarÄ± (chat) temiz tutunuz.</li>
          </ul>
        </div>

        <div class="connection-info">
          Durum: <span id="status">BaÄŸlanÄ±yor...</span>
        </div>
      </aside>

      <main class="reading-room">
        <header class="room-header">
          <h1>Sessiz Okuma Salonu</h1>
          <p>ArkanÄ±zdaki raflarda binlerce fikir var.</p>
        </header>

        <div class="chat-desk" id="messages">
          <div class="notice-board">
            <h2>HoÅŸ Geldiniz</h2>
            <p>Sessiz kÃ¼tÃ¼phane ortamÄ±na giriÅŸ yaptÄ±nÄ±z.</p>
          </div>
        </div>

        <div class="writing-desk">
          <input
            type="text"
            id="messageInput"
            placeholder="Bir not bÄ±rakÄ±n..."
            autocomplete="off"
          />
          <button id="sendBtn">FÄ±sÄ±lda âœ’ï¸</button>
        </div>
      </main>
    </div>

    <script>
      // Senin server.py dosyanla uyumlu Ã§alÄ±ÅŸan JS kodlarÄ±
      let ws;
      let userId;
      let username = "";

      const messagesDiv = document.getElementById("messages");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const statusSpan = document.getElementById("status");
      const userCountSpan = document.getElementById("userCount");
      const usernameInput = document.getElementById("usernameInput");
      const setUsernameBtn = document.getElementById("setUsernameBtn");

      function connect() {
        // Port 8765 server.py'de tanÄ±mlÄ±
        ws = new WebSocket("ws://" + window.location.hostname + ":8765");

        ws.onopen = () => {
          updateStatus("connected", "BaÄŸlÄ±");
          messageInput.disabled = false;
          sendBtn.disabled = false;
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleMessage(data);
          } catch (error) {
            console.error(error);
          }
        };

        ws.onclose = () => {
          updateStatus("disconnected", "Koptu");
          setTimeout(connect, 3000);
        };
      }

      function handleMessage(data) {
        switch (data.type) {
          case "welcome":
            userId = data.userId;
            username = `Ã–ÄŸrenci ${userId}`;
            usernameInput.value = username;
            addSystemMessage("KÃ¼tÃ¼phaneye giriÅŸ yaptÄ±nÄ±z.");
            break;
          case "chat":
            addChatMessage(data);
            break;
          case "system":
            addSystemMessage(data.message);
            break;
          case "usercount":
            userCountSpan.textContent = data.count;
            break;
        }
      }

      function addChatMessage(data) {
        const rowDiv = document.createElement("div");
        // MesajÄ±n bizden mi baÅŸkasÄ±ndan mÄ± geldiÄŸini kontrol et
        const isOwn = data.userId === userId;
        rowDiv.className = `message-row ${isOwn ? "own-row" : "other-row"}`;

        const cardDiv = document.createElement("div");
        cardDiv.className = "message-card";

        if (!isOwn) {
          const nameDiv = document.createElement("div");
          nameDiv.className = "sender-name";
          nameDiv.textContent = data.username;
          nameDiv.style.color = data.color; // Serverdan gelen rengi kullan
          cardDiv.appendChild(nameDiv);
        }

        const textP = document.createElement("p");
        textP.textContent = data.message;

        const timeSpan = document.createElement("span");
        timeSpan.className = "timestamp";
        timeSpan.textContent = data.timestamp;

        cardDiv.appendChild(textP);
        cardDiv.appendChild(timeSpan);
        rowDiv.appendChild(cardDiv);

        // Ä°lk aÃ§Ä±lÄ±ÅŸ mesajÄ±nÄ± temizle
        const notice = messagesDiv.querySelector(".notice-board");
        if (notice) notice.remove();

        messagesDiv.appendChild(rowDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addSystemMessage(msg) {
        const div = document.createElement("div");
        div.className = "system-log";
        div.textContent = `[Sistem] ${msg}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function sendMessage() {
        const txt = messageInput.value.trim();
        if (txt && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "chat", message: txt }));
          messageInput.value = "";
          messageInput.focus();
        }
      }

      function setUsername() {
        const newName = usernameInput.value.trim();
        if (
          newName &&
          newName !== username &&
          ws.readyState === WebSocket.OPEN
        ) {
          username = newName;
          ws.send(JSON.stringify({ type: "username", username: newName }));
        }
      }

      function updateStatus(cls, txt) {
        statusSpan.textContent = txt;
        statusSpan.className = cls;
      }

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
      setUsernameBtn.addEventListener("click", setUsername);

      connect();
    </script>
  </body>
</html>
