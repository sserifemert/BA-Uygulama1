<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sanal KÃ¼tÃ¼phane | EtÃ¼t OdasÄ±</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="library-layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h3>ğŸ“œ ZiyaretÃ§i Defteri</h3>
          <div class="online-status">
            <span class="indicator"></span>
            <span id="userCount">0</span> Ã–ÄŸrenci Ã‡alÄ±ÅŸÄ±yor
          </div>
        </div>

        <div class="user-controls">
          <label>Takma AdÄ±nÄ±z</label>
          <div class="input-group">
            <input
              type="text"
              id="usernameInput"
              placeholder="Ä°sim giriniz..."
              autocomplete="off"
            />
            <button id="setUsernameBtn">Yenile</button>
          </div>
        </div>

        <div class="library-rules">
          <h4>KÃ¼tÃ¼phane KurallarÄ±</h4>
          <ul>
            <li>LÃ¼tfen sessiz olunuz.</li>
            <li>Sadece bilgi paylaÅŸÄ±mÄ± yapÄ±nÄ±z.</li>
            <li>KitaplarÄ± (chat) temiz tutunuz.</li>
          </ul>
        </div>

        <div class="connection-info">
          Durum: <span id="status">BaÄŸlanÄ±yor...</span>
        </div>
      </aside>

      <main class="reading-room">
        <header class="room-header">
          <h1>Sessiz Okuma Salonu</h1>
          <p>ArkanÄ±zdaki raflarda binlerce fikir var.</p>
        </header>

        <div class="chat-desk" id="messages">
          <div class="notice-board">
            <h2>HoÅŸ Geldiniz</h2>
            <p>Sessiz kÃ¼tÃ¼phane ortamÄ±na giriÅŸ yaptÄ±nÄ±z.</p>
          </div>
        </div>

        <div class="quick-replies">
          <button class="quick-btn" onclick="sendQuick('ğŸ‘‹ Merhaba')">
            ğŸ‘‹ Merhaba
          </button>
          <button
            class="quick-btn"
            onclick="sendQuick('ğŸ“š Ne Ã§alÄ±ÅŸÄ±yorsunuz?')"
          >
            ğŸ“š Ne Ã§alÄ±ÅŸÄ±yorsunuz?
          </button>
          <button
            class="quick-btn"
            onclick="sendQuick('ğŸ¤« Biraz sessiz olabilir miyiz?')"
          >
            ğŸ¤« Sessizlik lÃ¼tfen
          </button>
          <button class="quick-btn" onclick="sendQuick('â˜• Mola veriyorum')">
            â˜• Mola veriyorum
          </button>
          <button
            class="quick-btn"
            onclick="sendQuick('âœ¨ Kolay gelsin herkese')"
          >
            âœ¨ Kolay gelsin
          </button>
        </div>

        <div id="mediaPicker" class="media-picker hidden">
          <div class="media-tabs">
            <button onclick="switchTab('emoji')" class="tab-btn active">
              Emojiler
            </button>
            <button onclick="switchTab('gif')" class="tab-btn">GIFler</button>
          </div>

          <div id="emojiPanel" class="media-content emoji-grid"></div>

          <div id="gifPanel" class="media-content gif-grid hidden"></div>
        </div>

        <div class="writing-desk">
          <button id="mediaToggleBtn" class="icon-btn">ğŸ˜Š</button>

          <input
            type="text"
            id="messageInput"
            placeholder="Bir not bÄ±rakÄ±n..."
            autocomplete="off"
          />
          <button id="sendBtn">FÄ±sÄ±lda âœ’ï¸</button>
        </div>
      </main>
    </div>

    <script>
      let ws;
      let userId;
      let username = "";

      const messagesDiv = document.getElementById("messages");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const statusSpan = document.getElementById("status");
      const userCountSpan = document.getElementById("userCount");
      const usernameInput = document.getElementById("usernameInput");
      const setUsernameBtn = document.getElementById("setUsernameBtn");

      // --- MEDYA DEÄÄ°ÅKENLERÄ° ---
      const emojis = [
        "ğŸ“š",
        "âœï¸",
        "â˜•",
        "ğŸ¤«",
        "âœ¨",
        "ğŸ•¯ï¸",
        "ğŸ“",
        "ğŸ§ ",
        "ğŸ’¡",
        "ğŸ¦‰",
        "ğŸ‚",
        "ğŸ“œ",
        "ğŸ‘“",
        "ğŸ•°ï¸",
        "ğŸµ",
        "ğŸ˜´",
        "ğŸ‘‹",
        "ğŸ‘",
        "â¤ï¸",
        "ğŸ¤”",
      ];
      const gifs = [
        "https://media.giphy.com/media/L0O3TQpp0WnSXmxV8p/giphy.gif",
        "https://media.giphy.com/media/3o7TKSjRrfIPjeiVyM/giphy.gif",
        "https://media.giphy.com/media/l0HlHJGHe3yAMhdQY/giphy.gif",
        "https://media.giphy.com/media/26hjhO9f3X6YF0Wha/giphy.gif",
        "https://media.giphy.com/media/xT9IgzoKnwFNmISR8I/giphy.gif",
        "https://media.giphy.com/media/l2Je66zG6mAAZxgqI/giphy.gif",
      ];

      // --- MEDYA PICKER MANTIÄI ---
      const mediaPicker = document.getElementById("mediaPicker");
      const mediaToggleBtn = document.getElementById("mediaToggleBtn");
      const emojiPanel = document.getElementById("emojiPanel");
      const gifPanel = document.getElementById("gifPanel");

      // Emojileri YÃ¼kle
      emojis.forEach((emo) => {
        const span = document.createElement("span");
        span.className = "emoji-item";
        span.textContent = emo;
        span.onclick = () => {
          messageInput.value += emo;
          messageInput.focus();
        };
        emojiPanel.appendChild(span);
      });

      // GIFleri YÃ¼kle
      gifs.forEach((gifUrl) => {
        const img = document.createElement("img");
        img.className = "gif-item";
        img.src = gifUrl;
        img.onclick = () => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "chat", message: gifUrl }));
            mediaPicker.classList.add("hidden");
          }
        };
        gifPanel.appendChild(img);
      });

      // Paneli AÃ§/Kapa
      mediaToggleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        mediaPicker.classList.toggle("hidden");
      });

      // DÄ±ÅŸarÄ± tÄ±klayÄ±nca kapat
      document.addEventListener("click", (e) => {
        if (!mediaPicker.contains(e.target) && e.target !== mediaToggleBtn) {
          mediaPicker.classList.add("hidden");
        }
      });

      // Tab DeÄŸiÅŸtirme
      window.switchTab = function (tabName) {
        const buttons = document.querySelectorAll(".tab-btn");
        buttons.forEach((btn) => btn.classList.remove("active"));

        if (tabName === "emoji") {
          emojiPanel.classList.remove("hidden");
          gifPanel.classList.add("hidden");
          buttons[0].classList.add("active");
        } else {
          emojiPanel.classList.add("hidden");
          gifPanel.classList.remove("hidden");
          buttons[1].classList.add("active");
        }
      };

      // --- WEBSOCKET BAÄLANTISI ---
      function connect() {
        ws = new WebSocket("ws://" + window.location.hostname + ":8765");

        ws.onopen = () => {
          updateStatus("connected", "BaÄŸlÄ±");
          messageInput.disabled = false;
          sendBtn.disabled = false;
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleMessage(data);
          } catch (error) {
            console.error(error);
          }
        };

        ws.onclose = () => {
          updateStatus("disconnected", "Koptu");
          setTimeout(connect, 3000);
        };
      }

      function handleMessage(data) {
        switch (data.type) {
          case "welcome":
            userId = data.userId;
            username = `Ã–ÄŸrenci ${userId}`;
            usernameInput.value = username;
            addSystemMessage("KÃ¼tÃ¼phaneye giriÅŸ yaptÄ±nÄ±z.");
            break;
          case "chat":
            addChatMessage(data);
            break;
          case "system":
            addSystemMessage(data.message);
            break;
          case "usercount":
            userCountSpan.textContent = data.count;
            break;
        }
      }

      function addChatMessage(data) {
        const rowDiv = document.createElement("div");
        const isOwn = data.userId === userId;
        rowDiv.className = `message-row ${isOwn ? "own-row" : "other-row"}`;

        const cardDiv = document.createElement("div");
        cardDiv.className = "message-card";

        if (!isOwn) {
          const nameDiv = document.createElement("div");
          nameDiv.className = "sender-name";
          nameDiv.textContent = data.username;
          nameDiv.style.color = data.color;
          cardDiv.appendChild(nameDiv);
        }

        // GIF KONTROLÃœ
        if (data.message.startsWith("http") && data.message.includes("giphy")) {
          const image = document.createElement("img");
          image.src = data.message;
          image.className = "chat-image";
          cardDiv.appendChild(image);
        } else {
          const textP = document.createElement("p");
          textP.textContent = data.message;
          cardDiv.appendChild(textP);
        }

        const timeSpan = document.createElement("span");
        timeSpan.className = "timestamp";
        timeSpan.textContent = data.timestamp;

        cardDiv.appendChild(timeSpan);
        rowDiv.appendChild(cardDiv);

        const notice = messagesDiv.querySelector(".notice-board");
        if (notice) notice.remove();

        messagesDiv.appendChild(rowDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addSystemMessage(msg) {
        const div = document.createElement("div");
        div.className = "system-log";
        div.textContent = `[Sistem] ${msg}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function sendMessage() {
        const txt = messageInput.value.trim();
        if (txt && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "chat", message: txt }));
          messageInput.value = "";
          messageInput.focus();
        }
      }

      // HazÄ±r Mesaj GÃ¶nder
      function sendQuick(text) {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "chat", message: text }));
          messageInput.focus();
        }
      }

      function setUsername() {
        const newName = usernameInput.value.trim();
        if (
          newName &&
          newName !== username &&
          ws.readyState === WebSocket.OPEN
        ) {
          username = newName;
          ws.send(JSON.stringify({ type: "username", username: newName }));
        }
      }

      function updateStatus(cls, txt) {
        statusSpan.textContent = txt;
        statusSpan.className = cls;
      }

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
      setUsernameBtn.addEventListener("click", setUsername);

      connect();
    </script>
  </body>
</html>
