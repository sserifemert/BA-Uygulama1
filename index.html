<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python WebSocket Sohbet</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ Python WebSocket Sohbet OdasÄ±</h1>
            <div class="header-info">
                <span class="connection-status" id="status">BaÄŸlanÄ±yor...</span>
                <span class="user-count">Online: <span id="userCount">0</span></span>
            </div>
        </header>

        <div class="username-section">
            <input type="text" id="usernameInput" placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin..." maxlength="20">
            <button id="setUsernameBtn">AdÄ± DeÄŸiÅŸtir</button>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="welcome-message">
                    <h2>HoÅŸ Geldiniz! ğŸ‘‹</h2>
                    <p>Python + WebSocket ile gerÃ§ek zamanlÄ± sohbet uygulamasÄ±.</p>
                    <p>Mesaj yazmaya baÅŸlayÄ±n!</p>
                </div>
            </div>
        </div>

        <div class="input-section">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." 
                maxlength="500"
                autocomplete="off"
            >
            <button id="sendBtn">GÃ¶nder</button>
        </div>
    </div>

    <script>
        // WebSocket baÄŸlantÄ±sÄ± (Python sunucusu 8765 portunda)
        let ws;
        let userId;
        let userColor;
        let username = '';

        // DOM elementleri
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusSpan = document.getElementById('status');
        const userCountSpan = document.getElementById('userCount');
        const usernameInput = document.getElementById('usernameInput');
        const setUsernameBtn = document.getElementById('setUsernameBtn');

        // WebSocket baÄŸlantÄ±sÄ±nÄ± baÅŸlat
        function connect() {
            // Python WebSocket sunucusuna baÄŸlan (port 8765)
            ws = new WebSocket('ws://' + window.location.hostname + ':8765');

            ws.onopen = () => {
                console.log('âœ… WebSocket baÄŸlantÄ±sÄ± kuruldu');
                updateStatus('connected', 'BaÄŸlandÄ± âœ“');
                messageInput.disabled = false;
                sendBtn.disabled = false;
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (error) {
                    console.error('âŒ Mesaj ayrÄ±ÅŸtÄ±rma hatasÄ±:', error);
                }
            };

            ws.onclose = () => {
                console.log('ğŸ”Œ WebSocket baÄŸlantÄ±sÄ± kapandÄ±');
                updateStatus('disconnected', 'BaÄŸlantÄ± Kesildi âœ—');
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                // 3 saniye sonra yeniden baÄŸlan
                setTimeout(() => {
                    console.log('ğŸ”„ Yeniden baÄŸlanÄ±lÄ±yor...');
                    updateStatus('connecting', 'BaÄŸlanÄ±yor...');
                    connect();
                }, 3000);
            };

            ws.onerror = (error) => {
                console.error('âŒ WebSocket hatasÄ±:', error);
                updateStatus('disconnected', 'Hata âœ—');
            };
        }

        // Mesaj iÅŸleme
        function handleMessage(data) {
            switch (data.type) {
                case 'welcome':
                    userId = data.userId;
                    userColor = data.color;
                    username = `KullanÄ±cÄ±${userId}`;
                    usernameInput.value = username;
                    addSystemMessage(data.message);
                    break;
                    
                case 'chat':
                    addChatMessage(data);
                    break;
                    
                case 'system':
                    addSystemMessage(data.message);
                    break;
                    
                case 'usercount':
                    userCountSpan.textContent = data.count;
                    break;
            }
        }

        // Sohbet mesajÄ± ekle
        function addChatMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.userId === userId ? 'own' : 'other'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (data.userId !== userId) {
                const usernameSpan = document.createElement('div');
                usernameSpan.className = 'message-username';
                usernameSpan.textContent = data.username;
                usernameSpan.style.color = data.color;
                contentDiv.appendChild(usernameSpan);
            }
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = data.message;
            contentDiv.appendChild(textDiv);
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = data.timestamp;
            contentDiv.appendChild(timeDiv);
            
            messageDiv.appendChild(contentDiv);
            
            // HoÅŸ geldin mesajÄ±nÄ± kaldÄ±r
            const welcomeMsg = messagesDiv.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        // Sistem mesajÄ± ekle
        function addSystemMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = message;
            
            const welcomeMsg = messagesDiv.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        // Mesaj gÃ¶nder
        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (message && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    message: message
                }));
                
                messageInput.value = '';
                messageInput.focus();
            }
        }

        // KullanÄ±cÄ± adÄ±nÄ± deÄŸiÅŸtir
        function setUsername() {
            const newUsername = usernameInput.value.trim();
            
            if (newUsername && newUsername !== username && ws.readyState === WebSocket.OPEN) {
                username = newUsername;
                ws.send(JSON.stringify({
                    type: 'username',
                    username: newUsername
                }));
            }
        }

        // BaÄŸlantÄ± durumunu gÃ¼ncelle
        function updateStatus(status, text) {
            statusSpan.textContent = text;
            statusSpan.className = `connection-status ${status}`;
        }

        // En alta kaydÄ±r
        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        setUsernameBtn.addEventListener('click', setUsername);

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                setUsername();
            }
        });

        // Sayfa yÃ¼klendiÄŸinde baÄŸlan
        connect();
    </script>
</body>
</html>